<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Périmètres de Sécurité (IA Officier)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" href="/favicon.png" type="image/png" />
    <style>
        /* ------------ VARIABLES ------------ */
        :root{
            --light-color: #f7f7f7;
            --dark-color: #2b2b2b;
            --dark-icon-color: #fff;
            --light-icon-color: #FFDE59;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--light-color);
            transition: background-color .3s ease;
        }
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .app-header {
            background-color: #333;
            color: white;
            padding: 10px;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            flex-shrink: 0;
            transition: background-color .3s ease;
        }
        main {
            flex-grow: 1;
            position: relative;
        }
        #map {
            height: 100%;
            width: 100%;
            background: #ddd;
        }
        .app-footer {
            background-color: #333;
            color: #ccc;
            padding: 8px;
            text-align: center;
            font-size: 10px;
            flex-shrink: 0;
            transition: background-color .3s ease;
        }
        .app-footer strong {
            color: #fff;
            font-weight: 500;
        }
        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 220px;
            font-size: 14px;
            transition: background-color .3s ease, color .3s ease, border .3s ease;
        }
        .legend {
            line-height: 1.8;
            color: #555;
        }
        .legend i {
            width: 16px;
            height: 16px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
            border-radius: 4px;
        }
        h3 {
            margin: 0 0 10px;
            color: #333;
            font-size: 16px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            transition: color .3s ease, border-color .3s ease, margin .4s ease, padding .4s ease;
        }
        .checkbox-container {
            margin-top: 10px;
        }
        .map-button {
            position: absolute;
            z-index: 1000;
            background: white;
            padding: 8px;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.25);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color .3s ease;
        }
        .geolocate-btn {
            bottom: 20px;
            left: 10px;
        }
        .reset-btn {
            bottom: 70px;
            left: 10px;
        }
        .share-btn {
            bottom: 120px;
            left: 10px;
        }
        
        .loader-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 20px;
            text-align: center;
            backdrop-filter: blur(5px);
        }
        .loader-overlay.visible {
            display: flex;
        }
        .spinner {
          border: 4px solid rgba(255, 255, 255, 0.3);
          border-radius: 50%;
          border-top: 4px solid #fff;
          width: 40px;
          height: 40px;
          animation: spin 1s linear infinite;
          margin-bottom: 15px;
        }
        #loader-text {
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        
        .weather-widget {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.85);
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            backdrop-filter: blur(5px);
            transition: background-color .3s ease, color .3s ease, border .3s ease;
        }
        #wind-direction {
            font-size: 16px;
            font-weight: 700;
            margin-right: 8px;
            width: 30px;
            text-align: center;
        }
        #wind-speed {
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
        }
        
        #coords-widget {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.7);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            color: #333;
        }
        .leaflet-control-scale-line {
            background: rgba(255, 255, 255, 0.7);
            color: #333;
            border-color: #555;
        }

        /* -------------- DESIGN MODE NUIT (AJUSTÉ) -------------- */
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
        }
        .btn{
            background-color: #fff;
            width: 4.5em;
            height: 2.2em;
            border-radius: 10em;
            padding: 0 0.2em;
            box-shadow: inset 0 2px 15px rgba(0,0,0, .1),
                        inset 0 2px 2px rgba(0,0,0, .1),
                        inset 0 -1px 1px rgba(0,0,0, .1);
            position: relative;
            display: flex;
            align-items: center;
            cursor: pointer;
            box-sizing: border-box;
        }
        .btn__indicator{
            background-color: #fff;
            width: 1.8em;
            height: 1.8em;
            border-radius: 50%;
            position: absolute;
            left: 0.2em;
            box-shadow: 0 2px 10px rgba(0,0,0, .2);
            transition: transform .3s ease;
        }
        .btn__icon-container{
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .btn__icon{
            color: var(--light-icon-color);
            font-size: 1rem;
        }
        .btn__icon.animated{
            animation: spin 0.5s;
        }
        @keyframes spin{
            to { transform: rotate(360deg); }
        }

        /* -------------- DARKMODE STYLES (AJUSTÉ) -------------- */
        body.dark-mode {
            background-color: var(--dark-color);
        }
        .dark-mode .leaflet-tile {
            filter: invert(1) hue-rotate(180deg) brightness(95%) contrast(90%);
        }
        .dark-mode .app-header, .dark-mode .app-footer {
            background-color: #1a1a1a;
        }
        .dark-mode .info-panel, .dark-mode .weather-widget {
            background-color: rgba(40, 40, 40, 0.85);
            color: #f0f0f0;
            border: 1px solid #555;
        }
        .dark-mode h3, .dark-mode .legend {
            color: #f0f0f0;
        }
        .dark-mode .map-button {
            background-color: #282828;
        }
        .dark-mode .map-button svg path {
            fill: #f0f0f0;
        }
        .dark-mode .btn{
            box-shadow: inset 0 2px 15px rgba(0,0,0, .3),
                        inset 2px 0 2px rgba(0,0,0, .3),
                        inset 0 -1px 1px rgba(0,0,0, .3);
        }
        .dark-mode .btn__indicator{
            transform: translateX(2.3em);
            background-color: var(--dark-color);
            box-shadow: 0 2px 10px rgba(0,0,0, .3);
        }
        .dark-mode .btn__icon{
            color: var(--dark-icon-color);
        }
        .dark-mode #coords-widget {
            background: rgba(40, 40, 40, 0.7);
            color: #f0f0f0;
        }
        .dark-mode .leaflet-control-scale-line {
            background: rgba(40, 40, 40, 0.7);
            color: #f0f0f0;
            border-color: #aaa;
        }

        /* -------------- NOUVEAUX STYLES POUR LA LÉGENDE RÉ rétractable -------------- */
        #legend-toggle {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #legend-toggle i {
            transition: transform 0.3s ease;
            font-size: 14px;
        }
        #legend-content {
            transition: max-height 0.4s ease-out, opacity 0.3s 0.1s, margin-top 0.4s ease;
            max-height: 400px;
            overflow: hidden;
            opacity: 1;
        }
        .info-panel.collapsed #legend-content {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in, opacity 0.2s, margin-top 0.4s ease;
        }
        .info-panel.collapsed h3 {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: 1px solid transparent;
        }
        .info-panel.collapsed #legend-toggle i {
            transform: rotate(-180deg);
        }


        @media (max-width: 600px) {
            .app-header { font-size: 14px; padding: 8px; }
            .app-footer { font-size: 9px; padding: 5px; }
            .info-panel {
                max-width: 160px;
                font-size: 12px;
            }
            h3 {
                font-size: 14px;
            }
            .geolocate-btn {
                bottom: 10px;
            }
             .reset-btn {
                bottom: 60px;
            }
             .share-btn {
                bottom: 110px;
            }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <header class="app-header">
            FLASH PGR
        </header>
        <main>
            <div id="map"></div>
            <div id="loader" class="loader-overlay">
                <div class="spinner"></div>
                <div id="loader-text">Réflexion en cours...</div>
            </div>
            <div id="weather-widget" class="weather-widget">
                <div id="wind-direction">--</div>
                <div id="wind-speed">-- km/h</div>
            </div>
            <div class="info-panel" id="info-panel">
                <h3 id="legend-toggle">Périmètres de Sécurité <i class="fa fa-chevron-up"></i></h3>
                <div id="legend-content">
                    <div class="legend">
                        <div><img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png" style="width:12px; height:20px; margin-left:2px; margin-right: 10px; float:left;">Emplacement fuite de gaz</div>
                        <div style="clear: both;"></div>
                        <div class="checkbox-container">
                            <label><input type="checkbox" id="pgr50m" checked> <i style="background: #ff0000;"></i>Zone d'exclusion (50 m)</label><br>
                            <label><input type="checkbox" id="pgr100m" checked> <i style="background: #ff9900;"></i>Zone contrôlée (100m)</label><br>
                            <label><input type="checkbox" id="cspe110m"> <i style="background: #0000ff;"></i>ZE CSPE 110 m</label><br>
                            <label><input type="checkbox" id="cspe180m"> <i style="background: #9900ff;"></i>ZC CSPE 180</label>
                        </div>
                    </div>
                    <div class="toggle-container">
                        <span>Mode Nuit</span>
                        <div class="btn">
                            <div class="btn__indicator">
                                <div class="btn__icon-container">
                                    <i class="btn__icon fa"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="map-button geolocate-btn" onclick="geolocate()" title="Me géolocaliser">
                <svg width="24" height="24" viewBox="0 0 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 8C9.79 8 8 9.79 8 12C8 14.21 9.79 16 12 16C14.21 16 16 14.21 16 12C16 9.79 14.21 8 12 8ZM20.94 11C20.48 6.83 17.17 3.52 13 3.06V1H11V3.06C6.83 3.52 3.52 6.83 3.06 11H1V13H3.06C3.52 17.17 6.83 20.48 11 20.94V23H13V20.94C17.17 20.48 20.48 17.17 20.94 13H23V11H20.94ZM12 19C8.13 19 5 15.87 5 12C5 8.13 8.13 5 12 5C15.87 5 19 8.13 19 12C19 15.87 15.87 19 12 19Z" fill="red"/>
                </svg>
            </div>
             <div class="map-button reset-btn" onclick="resetMap()" title="Réinitialiser la carte">
                <svg width="24" height="24" viewBox="0 0 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="#555"/>
                </svg>
            </div>
            <div class="map-button share-btn" onclick="shareSituation()" title="Partager la situation">
                <svg width="24" height="24" viewBox="0 0 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3z" fill="#555"/>
                </svg>
            </div>
            <div id="coords-widget">Lat: --, Lng: --</div>
        </main>
        <footer class="app-footer">
            Application libre de droit - <strong>Cette application ne remplace pas l'analyse terrain.</strong>
        </footer>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- INITIALISATION DE LA CARTE ---
            const map = L.map('map').setView([45.5256, 4.8748], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);

            let sourceMarker = null;
            let perimeterLayers = [];
            let windLayer = null;
            let thinkingInterval = null;
            let isUpdating = false;
            let lastWindData = null;
            
            const VIENNE_COORDS = { lat: 45.525, lon: 4.874 };
            
            const redIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            // --- FONCTIONS UTILITAIRES ---
            function calculatePointOnCircle(center, radius, bearingDeg) {
                const bearingRad = bearingDeg * Math.PI / 180;
                const latRad = center.lat * Math.PI / 180;
                
                const dLat = radius * Math.cos(bearingRad);
                const dLon = radius * Math.sin(bearingRad);

                const newLat = center.lat + (dLat / 111320);
                const newLng = center.lng + (dLon / (111320 * Math.cos(latRad)));

                return L.latLng(newLat, newLng);
            }

            function degreesToCardinal(deg) {
                const directions = ['N', 'NE', 'E', 'SE', 'S', 'SO', 'O', 'NO'];
                const index = Math.round((deg || 0) / 45) % 8;
                return directions[index];
            }
            
            async function getWindData(lat, lon) {
                const url = `https://api.open-meteo.com/v1/meteofrance?latitude=${lat}&longitude=${lon}&hourly=wind_speed_10m,wind_direction_10m`;
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data.hourly && data.hourly.time) {
                        const now = new Date();
                        const currentHourISO = now.toISOString().substring(0, 13) + ":00";
                        const hourIndex = data.hourly.time.findIndex(t => t === currentHourISO);
                        const index = hourIndex !== -1 ? hourIndex : 0;
                        
                        const speed = data.hourly.wind_speed_10m[index];
                        const deg = data.hourly.wind_direction_10m[index];
                        
                        lastWindData = { speed: speed, deg: deg };
                        return lastWindData;
                    }
                    return null;
                } catch (error) {
                    console.error("Erreur de l'API Météo:", error);
                    return null;
                }
            }
            
            async function updateWeatherWidget(lat, lon) {
                const data = await getWindData(lat, lon);
                if (data) {
                    const windSpeedKmh = (data.speed || 0).toFixed(1);
                    const windDirectionText = degreesToCardinal(data.deg);
                    document.getElementById('wind-direction').textContent = windDirectionText;
                    document.getElementById('wind-speed').textContent = `${windSpeedKmh} km/h`;
                }
            }

            // --- GESTION DE L'AFFICHAGE SUR LA CARTE ---
            async function updateMap(latlng, showPopup = false) {
                if (isUpdating) return;
                isUpdating = true;

                const loader = document.getElementById('loader');
                const loaderText = document.getElementById('loader-text');
                
                const thinkingMessages = [
                    "Analyse du secteur...",
                    "Récupération des données météo...",
                ];
                let messageIndex = 0;

                try {
                    loaderText.textContent = thinkingMessages[0];
                    loader.classList.add('visible');
                    thinkingInterval = setInterval(() => {
                        messageIndex = (messageIndex + 1) % thinkingMessages.length;
                        loaderText.textContent = thinkingMessages[messageIndex];
                    }, 1000);
                    
                    await updateWeatherWidget(latlng.lat, latlng.lng);

                    // Nettoyage complet
                    resetMap();

                    sourceMarker = L.marker(latlng, { icon: redIcon }).addTo(map);
                    if (showPopup) {
                        sourceMarker.bindPopup("Emplacement à priori de la fuite, de gaz").openPopup();
                    }

                    const perimeters = [
                        { radius: 50, color: '#ff0000', id: 'pgr50m' },
                        { radius: 100, color: '#ff9900', id: 'pgr100m' },
                        { radius: 110, color: '#0000ff', id: 'cspe110m' },
                        { radius: 180, color: '#9900ff', id: 'cspe180m' }
                    ];

                    let circle100m = null;
                    perimeters.forEach(p => {
                        const checkbox = document.getElementById(p.id);
                        if (!checkbox || checkbox.checked) {
                            const circle = L.circle(latlng, {
                                color: p.color,
                                fillColor: p.color,
                                fillOpacity: 0.2,
                                radius: p.radius
                            }).addTo(map);
                            perimeterLayers.push(circle);
                            if (p.radius === 100) {
                                circle100m = circle;
                            }
                        }
                    });

                    const wind = await getWindData(latlng.lat, latlng.lng);
                    
                    if (wind && typeof wind.deg === 'number') {
                        const gasTravelDirection = (wind.deg + 180) % 360;
                        windLayer = L.polygon([
                            latlng,
                            calculatePointOnCircle(latlng, 200, gasTravelDirection - 22.5),
                            calculatePointOnCircle(latlng, 200, gasTravelDirection + 22.5)
                        ], { color: 'orange', fillColor: 'orange', fillOpacity: 0.2, weight: 1, dashArray: '5, 5' }).addTo(map);
                        
                        const windIndicatorText = L.divIcon({
                            className: 'wind-text-indicator',
                            html: `<div style="font-weight:bold; font-size:12px; color:orange; text-shadow: 0 0 2px white, 0 0 2px white;">Axe du vent</div>`,
                            iconSize: [100, 20],
                            iconAnchor: [50, 10]
                        });
                        const windMarker = L.marker(calculatePointOnCircle(latlng, 210, gasTravelDirection), { icon: windIndicatorText }).addTo(map);

                        perimeterLayers.push(windLayer, windMarker);
                    }
                    
                    if (circle100m) {
                        map.flyToBounds(circle100m.getBounds());
                    } else {
                        const group = new L.featureGroup([sourceMarker, ...perimeterLayers]);
                        if (group.getLayers().length > 0) {
                           map.flyToBounds(group.getBounds().pad(0.2));
                        }
                    }

                } finally {
                    clearInterval(thinkingInterval);
                    loader.classList.remove('visible');
                    isUpdating = false;
                }
            }

            window.resetMap = function() {
                if (sourceMarker) map.removeLayer(sourceMarker);
                perimeterLayers.forEach(layer => map.removeLayer(layer));
                if (windLayer) map.removeLayer(windLayer);
                sourceMarker = null;
                perimeterLayers = [];
                windLayer = null;
            }

            // --- GESTIONNAIRES D'ÉVÉNEMENTS ---
            map.on('click', (e) => updateMap(e.latlng, false));

            ['pgr50m', 'pgr100m', 'cspe110m', 'cspe180m'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    if (sourceMarker) updateMap(sourceMarker.getLatLng(), false);
                });
            });

            // LOGIQUE POUR LE MODE NUIT
            const body = document.querySelector('body');
            const btn = document.querySelector('.btn');
            const icon = document.querySelector('.btn__icon');

            function store(value){
                localStorage.setItem('dark-mode', value);
            }

            function load(){
                const darkMode = localStorage.getItem('dark-mode');
                if(!darkMode){
                    store(false);
                    icon.classList.add('fa-sun');
                } else if( darkMode == 'true'){
                    body.classList.add('dark-mode');
                    icon.classList.add('fa-moon');
                } else if(darkMode == 'false'){
                    icon.classList.add('fa-sun');
                }
            }

            load();

            btn.addEventListener('click', () => {
                body.classList.toggle('dark-mode');
                icon.classList.add('animated');
                store(body.classList.contains('dark-mode'));
                if(body.classList.contains('dark-mode')){
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                }else{
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                }
                setTimeout( () => {
                    icon.classList.remove('animated');
                }, 500)
            });

            // NOUVELLE LOGIQUE POUR LA LÉGENDE RÉ rétractable
            const infoPanel = document.getElementById('info-panel');
            const legendToggle = document.getElementById('legend-toggle');

            legendToggle.addEventListener('click', () => {
                infoPanel.classList.toggle('collapsed');
            });


            window.geolocate = function() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const latlng = L.latLng(position.coords.latitude, position.coords.longitude);
                            map.flyTo(latlng, 16);
                            updateMap(latlng, true);
                        },
                        (error) => {
                            alert(`Échec de la géolocalisation: ${error.message}`);
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                    );
                } else {
                    alert("La géolocalisation n'est pas prise en charge par votre navigateur.");
                }
            }
            
            window.shareSituation = function() {
                if (!sourceMarker) {
                    alert("Veuillez d'abord définir un point sur la carte.");
                    return;
                }
                const lat = sourceMarker.getLatLng().lat.toFixed(5);
                const lng = sourceMarker.getLatLng().lng.toFixed(5);
                const subject = "Situation Tactique FLASH PGR";
                let body = `Point d'origine de la fuite :\nLat: ${lat}, Lng: ${lng}\n\n`;
                if (lastWindData) {
                    body += `Vent : Vient du ${degreesToCardinal(lastWindData.deg)} (${lastWindData.deg}°) à environ ${lastWindData.speed.toFixed(1)} km/h.\n\n`;
                }
                body += `Lien vers la carte : https://www.openstreetmap.org/#map=18/${lat}/${lng}`;
                
                const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.location.href = mailtoLink;
            }
            
            // Initialiser le widget météo pour Vienne au chargement
            updateWeatherWidget(VIENNE_COORDS.lat, VIENNE_COORDS.lon);
            
            // Ajout de l'échelle et des coordonnées
            L.control.scale({ imperial: false }).addTo(map);
            const coordsWidget = document.getElementById('coords-widget');
            map.on('mousemove', (e) => {
                if(coordsWidget) {
                    coordsWidget.innerHTML = `Lat: ${e.latlng.lat.toFixed(5)}, Lng: ${e.latlng.lng.toFixed(5)}`;
                }
            });
        });
    </script>
</body>
</html>
```
